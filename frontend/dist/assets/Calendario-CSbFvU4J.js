import{r as N,p as Z,u as F,I as O,H as I,a as k,D as J,n as _,q as b,j as e,E as p,b as V,M as K,s as Q,c as W,t as X,R as E}from"./index-D7SXAQHN.js";import{f as ee,c as z}from"./fechasDelCalendarioSemanal-CwVxtige.js";import{f as B,a as U,u as P,b as ae}from"./useLoaderContext-0fYFxd9T.js";import{u as C}from"./useReservasContext-DOSQuCKI.js";import{B as y}from"./Button-lIR1oaxr.js";import{L as te}from"./LabelInput-BomlkQxr.js";import{f as $}from"./formatFechaParaUser-B35bwiOM.js";import{f as se}from"./formatHoraUser-DhkUKUiJ.js";import{C as oe}from"./ContenedorReservas-DZ77-SBI.js";import{T as M}from"./TransitionNumber-Dtvs2k4z.js";import"./ConfirmationModal-aPwLUnHm.js";import"./useObserver-CwXYJtvj.js";const re=async(o,t)=>{const r={headers:{"Content-Type":"application/json",Authorization:`Bearer ${o||""}`}},s=`${U.reservas.deLaSemana}${t}`;return await B(s,r)},ne=(o,t,r,s)=>{const a=new Date(o),n=new Date(a.getFullYear(),a.getMonth(),1),i=new Date(a.getFullYear(),a.getMonth()+1,0),c=[];for(let l=n;l<=i;l.setDate(l.getDate()+1)){const d=[];for(let m=t;m<=r;m++)for(let f=0;f<60;f+=s){const h=new Date(l);h.setHours(m,f,0),d.push(h)}c.push({dia:new Date(l),horas:d})}return c},j=()=>N.useContext(Z),ie=async(o,t)=>{const r={headers:{"Content-Type":"application/json",Authorization:`Bearer ${o||""}`}},s=`${U.reservas.delMes}${t}`;return await B(s,r)},ce=()=>{const{diaDeLaSemana:o,mesActual:t,dispatch:r,vistaSemana:s}=j(),{setMensaje:a}=F(),{accessToken:n}=P(),{setLoading:i}=ae(),{dispatch:c}=C(),l=ee(o,J,k,I,O),d=ne(t,k,I,O);return N.useEffect(()=>{s&&o&&(async()=>{i(!0);const u=await re(n,o),{datos:g,error:v,status:w}=u;w===200?c({type:_.SET_RESERVAS,payload:g}):a(v||"Ocurrió un error al obtener las reservas de la semana"),i(!1)})()},[s,n,a,o,c,i]),N.useEffect(()=>{!s&&t&&(async()=>{i(!0);const u=await ie(n,t),{datos:g,error:v,status:w}=u;w===200?c({type:_.SET_RESERVAS_MES,payload:g}):a(v||"Ocurrió un error al obtener las reservas de la semana"),i(!1)})()},[s,n,a,t,c,i]),{diasSemana:l,setSeleccionadas:x=>{c({type:_.SET_RESERVAS_SELECCIONADAS,payload:x})},seleccionarDia:x=>{r({type:b.SET_DIA_SEMANA,payload:x}),localStorage.setItem("currentDay",x)},seleccionarMes:x=>{const u=x.split("-").slice(0,-1).join("-")+"-02";r({type:b.SET_MES,payload:u}),localStorage.setItem("currentMonth",u)},diasMes:d}},le=({handleSeleccionarDia:o,seleccionarMes:t})=>{const{dispatch:r,vistaSemana:s}=j(),a=c=>{const l=c.target.value;l&&(s?o(l):t(l))},n=()=>{r(s?{type:b.SET_SEMANA_ANTERIOR}:{type:b.SET_MES_ANTERIOR})},i=()=>{r(s?{type:b.SET_SEMANA_SIGUIENTE}:{type:b.SET_MES_SIGUIENTE})};return e.jsxs("section",{className:"grid grid-cols-2 gap-4 border-t border-b border-black p-4 sticky top-28 z-20 bg-white ",children:[e.jsx("div",{className:"grid col-span-full",children:e.jsx(te,{className:"text-center",labelText:"Buscar día",type:"date",onChange:c=>{a(c),c.target.value=""}})}),e.jsx(y,{className:"w-full m-auto",onClickFunction:n,texto:"Anterior",tipo:"button"}),e.jsx(y,{className:"w-full m-auto",onClickFunction:i,texto:"Siguiente",tipo:"button"})]})},de=({horas:o,reservarHora:t})=>{const{reservas:r}=C();return e.jsx("ul",{className:"grid gap-2 p-2 items-start self-start",children:o.map(s=>{const a=s.getDay(),n=s.getHours(),i=a===0||a===6||n<=8,{reservaAdmin:c,id:l,estado:d,proximaHoraNoDisponible:m}=z(s,r);return e.jsx("li",{"data-fecha":l,onClick:t,className:`${d} ${c?"outline outline-2 outline-color-violeta":""} ${i?"outline outline-2 outline-color-violeta horaAdmin":""} ${pe(d,m)} text-center rounded-md hover:scale-105 transition-transform`,children:se(s)},s)})})},pe=(o,t)=>{const r=t,s=o,a=s&&(s===p.pago||s===p.pendiente);return[o&&`${o} text-white`,!r&&!a&&"cursor-pointer",a&&"cursor-pointer",r&&!a&&"opacity-50 cursor-not-allowed"].filter(Boolean).join(" ")},me=({diasSemana:o,reservarHora:t})=>e.jsx("section",{className:"grid grid-cols-6",children:o.map(r=>{const s=new Date(r.dia),a=s.getDay(),i=a===0||a===6||a===5||a===4?"col-span-3":"col-span-2";return e.jsxs("div",{className:`grid grid-rows-[50px,1fr] gap-2 ${i}`,children:[e.jsx("h3",{className:`grid place-content-center text-center capitalize text-md p-2 text-color-violeta font-betonga font-bold tracking-wide text-pretty border-b border-black sticky top-[270px] z-10 ${s.toLocaleDateString()===new Date().toLocaleDateString()?"bg-color-verde-blanco":"bg-white"}`,children:$(r.dia)}),e.jsx(de,{horas:r.horas,reservarHora:t})]},s)})}),xe=({handleSeleccionarDia:o,diasSemana:t,diasMes:r})=>{var l,d;const{vistaSemana:s}=j(),a=new Date(t[0].dia),n=new Date(t[6].dia),i=new Date((l=r[0])==null?void 0:l.dia),c=new Date((d=r[r.length-1])==null?void 0:d.dia);return e.jsx("section",{className:"grid flex-1",children:e.jsxs("ul",{className:"grid gap-y-4 text-center text-color-violeta font-bold",children:[e.jsxs("li",{onClick:()=>o(V.split("T")[0]),className:"p-2 bg-color-verde-blanco font-betonga rounded-lg border border-color-violeta cursor-pointer",children:["Hoy ",$(V)]}),s?e.jsxs("li",{children:[a.toLocaleDateString()," al ",n.toLocaleDateString()]}):e.jsxs("li",{children:[i.toLocaleDateString()," al ",c.toLocaleDateString()]})]})})};function ue(o){const t=o.reduce((r,s)=>(s.estado===p.pago?r.terminadas++:s.estado===p.cancelada?r.canceladas++:s.estado===p.pendiente&&r.pendientes++,r),{terminadas:0,canceladas:0,pendientes:0});return{reservasCanceladas:t.canceladas,reservasPendientes:t.pendientes,reservasTerminadas:t.terminadas,reservasTodas:t.canceladas+t.pendientes+t.terminadas}}function ge({setSeleccionadas:o}){const[t,r]=N.useState(!1),{reservas:s,reservasMes:a}=C(),{vistaSemana:n}=j(),{reservasCanceladas:i,reservasPendientes:c,reservasTerminadas:l,reservasTodas:d}=ue(n?s:a),m=x=>{if(x==="Todas")o(s);else{const u=s.filter(g=>g.estado===x);o(u)}},f=()=>{r(!t)},h=x=>{const u=x.currentTarget.id;m(u)};return e.jsxs("div",{className:"m-auto w-full max-w-4xl flex flex-col items-center gap-4 mb-4",children:[e.jsx(y,{tipo:"button",texto:`${t?"Ocultar Contador":"Mostrar Contador"}`,onClickFunction:f}),e.jsxs("section",{className:`w-full flex flex-wrap gap-4 [&>div]:flex-1 [&>div]:p-3 [&>div]:text-center [&>div]:rounded-md [&>div]:cursor-pointer [&>div]:transition-colors [&>div]:text-white [&>div]:font-betonga [&>div]:tracking-wider [&>div]:border hover:[&>div]:bg-slate-200 hover:[&>div]:text-color-violeta ${t?"opacity-100 h-auto max-h-[500px] transition-[opacity_max-height] pointer-events-auto":"opacity-0  max-h-0 transition-[opacity_max-height] pointer-events-none"}`,children:[e.jsxs("div",{id:p.pendiente,className:p.pendiente,onClick:h,children:[e.jsx("p",{className:"font-bold",children:"Pendientes"}),e.jsx("strong",{className:"text-2xl",children:c})]}),e.jsxs("div",{id:p.cancelada,className:p.cancelada,onClick:h,children:[e.jsx("p",{className:"font-bold",children:"Canceladas"}),e.jsx("strong",{className:"text-2xl",children:e.jsx(M,{to:i})})]}),e.jsxs("div",{id:p.pago,className:p.pago,onClick:h,children:[e.jsx("p",{className:"font-bold",children:"Pagas"}),e.jsx("strong",{className:"text-2xl",children:e.jsx(M,{to:l})})]}),e.jsxs("div",{id:"Todas",className:"border-slate-400",onClick:h,children:[e.jsx("p",{className:"font-bold text-color-violeta",children:"Todas"}),e.jsx("strong",{className:"text-2xl text-color-violeta",children:e.jsx(M,{to:d})})]})]})]})}const he=(o,t,r)=>{const s=o.map(a=>({fecha:a.dia,pendiente:0,cancelada:0,paga:0,libre:r}));return t.forEach(a=>{const n=new Date(a.horario.horaInicio),i=s.find(c=>c.fecha.toDateString()===n.toDateString());a.paciente.nombre!=="admin"&&i&&(a.estado===p.pendiente?(i.pendiente++,i.libre--):a.estado===p.cancelada?i.cancelada++:a.estado===p.pago&&(i.paga++,i.libre--))}),s.forEach(a=>{const n=r;n>0&&(a.pendiente=a.pendiente/n*100,a.cancelada=a.cancelada/n*100,a.paga=a.paga/n*100,a.libre=a.libre/n*100)}),s},fe=({diasMes:o,handleSeleccionarDia:t})=>{const{dispatch:r}=j(),{reservasMes:s}=C(),a=N.useRef(),n=he(o,s,I-k),i=K[o[0].dia.getMonth()],c=l=>{t(l),a.current&&a.current.scrollIntoView(),r({type:b.SET_VISTA_SEMANA,payload:!0})};return e.jsxs("section",{className:"grid p-4 gap-4 md:grid-cols-2",ref:a,children:[e.jsxs("h3",{className:"sticky top-[270px] z-10 col-span-full bg-white font-betonga text-center text-color-violeta font-bold text-xl p-2",children:[i," del ",o[0].dia.getFullYear()]}),o.map((l,d)=>{const m=new Date(l.dia),f=m.toLocaleDateString().split("/").reverse().join("-"),{pendiente:h,paga:x,cancelada:u,libre:g}=n[d];return e.jsxs("article",{onClick:()=>c(f),className:"grid capitalize p-4 gap-2 border border-black rounded-lg overflow-hidden cursor-pointer hover:scale-95 transition-transform",children:[e.jsx("h3",{className:`grid p-2 text-color-violeta rounded-lg font-betonga font-bold text-center ${m.toLocaleDateString()===new Date().toLocaleDateString()?"bg-color-verde-blanco":"bg-white"}`,children:$(m)}),n[d].pendiente||n[d].cancelada||n[d].paga?e.jsxs("ul",{className:"flex h-4  w-full border border-black rounded-xl  overflow-hidden",children:[e.jsx(R,{bgColorTailwind:"bg-color-pendiente",porcentaje:h}),e.jsx(R,{bgColorTailwind:"bg-color-cancelada",porcentaje:u}),e.jsx(R,{bgColorTailwind:"bg-color-paga",porcentaje:x}),e.jsx(R,{bgColorTailwind:"bg-white",porcentaje:g})]}):e.jsx("ul",{className:"flex h-4 w-full border border-black rounded-xl  overflow-hidden",children:e.jsx("li",{})}),e.jsxs("ul",{className:"grid grid-flow-col border border-black rounded-lg overflow-hidden",children:[e.jsx(T,{bgColorTailwind:"bg-color-pendiente",porcentaje:h}),e.jsx(T,{bgColorTailwind:"bg-color-cancelada",porcentaje:u}),e.jsx(T,{bgColorTailwind:"bg-color-paga",porcentaje:x}),e.jsx(T,{bgColorTailwind:"bg-white",porcentaje:g})]})]},m)})]})},R=({porcentaje:o,bgColorTailwind:t})=>e.jsx("li",{style:{width:`${o}%`},className:`${t} text-white`}),T=({porcentaje:o,bgColorTailwind:t})=>{const r=t==="bg-white"?"text-black":"text-white";return e.jsxs("li",{className:`${t} p-2 text-center ${r}`,children:[o.toFixed(1),"%"]})};function be(){const{vistaSemana:o}=j(),[t,r]=N.useState(!1),s=()=>{r(!t)};return o&&e.jsxs("div",{className:"absolute bottom-0 right-0 w-full grid justify-end",children:[e.jsx("i",{className:"p-4 cursor-pointer hover:scale-105",onClick:s,children:e.jsx(Q,{})}),t&&e.jsxs("div",{className:"absolute top-full right-8 z-30 bg-white grid gap-2 grid-cols-3 text-center",children:[e.jsx(S,{text:"Crear reserva con nombre admin.",className:"outline outline-2 outline-color-violeta"}),e.jsx(S,{text:"Hora no disponible para reservar.",className:"opacity-50"}),e.jsx(S,{text:"Hora libre para reservar.",className:""}),e.jsx(S,{text:"Hora no disponible para reservar con estado pago.",className:`${p.pago} text-white`}),e.jsx(S,{text:"Hora no disponible para reservar con estado pendiente.",className:`${p.pendiente} text-white`}),e.jsx(S,{text:"Hora libre para reservar con estado cancelada.",className:`${p.cancelada} text-white`})]})]})}const S=({text:o,className:t})=>e.jsxs("div",{className:"group relative",children:[e.jsx("p",{className:`${t} px-2 rounded w-full grid place-content-center cursor-default`,children:"09:00"}),e.jsx("p",{className:"group-hover:scale-100 scale-0 transition-transform absolute left-0 top-0 z-30 rounded px-2 text-sm border border-slate-200 shadow-lg bg-white",children:o})]});function Me(){const o=W(),{setMensaje:t}=F(),{loading:r}=P(),{reservas:s,seleccionadas:a}=C(),{diasSemana:n,diasMes:i,setSeleccionadas:c,seleccionarDia:l,seleccionarMes:d}=ce(),{vistaSemana:m,dispatch:f}=j(),h=()=>{c([])},x=()=>{f({type:b.SET_VISTA_SEMANA,payload:!m})},u=g=>{const v="admin",w=g.target.getAttribute("data-fecha"),{estado:D,proximaHoraNoDisponible:Y,reservadas:L,id:H}=z(new Date(`${w}`),s),G=D&&D!==p.cancelada||Y,q=D;if(D===p.pago||D===p.pendiente){c(L);return}if(q&&c(L),G){t("Hora no disponible para hacer una reserva");return}if(g.target.className.includes("horaAdmin")){const A={horario:{horaInicio:H},paciente:{nombre:v}};o(E.admin.agregarReserva,{state:{from:E.admin.calendario,reserva:A}})}else{const A={horario:{horaInicio:H}};o(E.admin.agregarReserva,{state:{from:E.admin.calendario,reserva:A}})}};return e.jsxs(e.Fragment,{children:[r&&e.jsx(X,{}),(a==null?void 0:a.length)>0?e.jsx(oe,{reservas:a,cerrarReserva:h}):null,e.jsxs("main",{className:"grid py-8 px-2 w-full relative ",children:[e.jsx(ge,{setSeleccionadas:c}),e.jsxs("article",{className:"max-w-4xl grid justify-self-center border rounded-lg border-black w-full ",children:[e.jsxs("div",{className:"relative grid grid-cols-[8fr_1fr] items-start p-4 gap-x-4",children:[e.jsx(xe,{handleSeleccionarDia:g=>{m?l(g):d(g)},diasSemana:n,diasMes:i}),e.jsx(be,{}),e.jsx(y,{className:"w-full",tipo:"button",onClickFunction:x,texto:m?"Semana":"Mes"})]}),e.jsx(le,{handleSeleccionarDia:l,seleccionarMes:d}),m?e.jsx(me,{diasSemana:n,reservarHora:u}):e.jsx(fe,{diasMes:i,handleSeleccionarDia:l})]})]})]})}export{Me as default};
