import{j as o,E as S,I as B,H as k,a as q,D as M,u as I,r as w,n as R,m as J,c as G,R as F}from"./index-D7SXAQHN.js";import{u as Z}from"./useForm-CHJZnCkj.js";import{B as _}from"./Button-lIR1oaxr.js";import{L as v}from"./LabelInput-BomlkQxr.js";import{T as K}from"./TextAreaLabel-BpRQ34pw.js";import{S as Q}from"./SelectServicio-owglHSM5.js";import{f as W}from"./formatFechaParaUser-B35bwiOM.js";import{c as $,f as X}from"./fechasDelCalendarioSemanal-CwVxtige.js";import{f as Y}from"./formatHoraUser-DhkUKUiJ.js";import{D as ee}from"./Dropdown-CiSBuAr5.js";import{a as y,f as D,u as oe,b as O}from"./useLoaderContext-0fYFxd9T.js";import{u as H}from"./useReservasContext-DOSQuCKI.js";import{T as re}from"./TextErrorForm-D2OMVORA.js";import{u as ae,a as te}from"./usePaciente-21l7RI9C.js";import"./getServiciosNombresYTratamientos-eaN0aF5L.js";const se=({values:e})=>o.jsxs("ul",{className:"grid gap-2 border-t border-b border-slate-500 py-4",children:[o.jsx("li",{className:"text-color-violeta text-xl text-center mb-4",children:"Resumen de la reserva"}),e.nombre&&o.jsxs("li",{className:"capitalize grid gap-4 grid-cols-[1fr_2fr] bg-white p-4 rounded-lg text-color-violeta",children:["Nombre ",o.jsx("strong",{className:"text-end",children:e.nombre})]}),e.horaInicio&&o.jsxs("li",{className:"capitalize grid gap-4 grid-cols-[1fr_2fr] bg-white p-4 rounded-lg text-color-violeta",children:["Dia",o.jsx("strong",{className:"text-end",children:W(new Date(`${e.horaInicio} 00:00:00`))})]}),e.hora&&o.jsxs("li",{className:"grid gap-4 grid-cols-[1fr_2fr] bg-white p-4 rounded-lg text-color-violeta",children:["Hora ",o.jsx("strong",{className:"text-end",children:e.hora})]}),e.observaciones&&o.jsxs("li",{className:"grid grid-cols-[1fr_2fr] gap-4 bg-white p-4 rounded-lg text-color-violeta",children:["Observaciones",o.jsx("strong",{className:"text-end text-nowrap overflow-auto",children:e.observaciones})]}),e.servicio&&o.jsxs("li",{className:"grid gap-4 grid-cols-[1fr_2fr] bg-white p-4 rounded-lg text-color-violeta",children:["Servicio",o.jsx("strong",{className:"capitalize text-end text-nowrap overflow-auto",children:e.servicio})]}),e.tratamiento&&o.jsxs("li",{className:"grid gap-4 grid-cols-[1fr_2fr] bg-white p-4 rounded-lg text-color-violeta ",children:["Tratamiento",o.jsx("strong",{className:"text-end text-nowrap overflow-auto",children:e.tratamiento})]})]}),ne=({horasDisponibles:e,values:t,reservasDelDia:r,handleChange:a,setMensaje:i,errors:c})=>{const p=u=>{const l=u.target.textContent,n={target:{name:"hora",value:l}},s=$(new Date(`${t.horaInicio} ${l}`),r);if(s.estado&&s.estado!==S.cancelada||s.proximaHoraNoDisponible){i("Hora no disponible para hacer una reserva");return}else a(n)};return o.jsxs(o.Fragment,{children:[o.jsxs("ul",{className:"grid gap-4 grid-cols-4",children:[o.jsx("li",{className:"col-span-full",children:"Hora"}),e.map(u=>{const{reservaAdmin:l,id:n,estado:s,proximaHoraNoDisponible:d}=u,m=n.split("T")[1]===t.hora;return o.jsx("li",{className:`${s} ${l?"outline outline-2 outline-color-violeta":""} p-2 rounded-xl w-full grid place-content-center shadow-md max-w-20 transition-[max-width] ${ie(s,d,m)} `,onClick:p,children:n.split("T")[1]},n)})]}),c.hora&&o.jsxs("small",{className:"text-red-600",children:["* ",c.hocra]})]})},ie=(e,t,r)=>{const a=t,i=e,c=i&&(i===S.pago||i===S.pendiente);return[e&&`${e} text-white`,!a&&!c&&!r&&"cursor-pointer  bg-white",c&&"cursor-not-allowed",a&&!c&&"opacity-50 cursor-not-allowed",r&&"bg-color-violeta col-span-full row-start-2 text-white max-w-xl font-bold opacity-100 cursor-default"].filter(Boolean).join(" ")},ce=e=>({pacienteNombre:e.nombre,fecha:new Date(`${e.horaInicio} ${e.hora}:00`),observaciones:e.observaciones,servicio:e.servicio,tratamiento:e.tratamiento,estado:e.estado||""}),le={nombre:{required:!0},horaInicio:{required:!0},servicio:{required:!0},tratamiento:{required:!0},hora:{required:!0}},de=(e,t,r)=>{var u,l,n,s,d,m;const a=((u=e==null?void 0:e.tratamiento)==null?void 0:u.descripcion)||"",i=(l=e==null?void 0:e.tratamiento)==null?void 0:l.sesiones;let c="";return a&&i!==void 0&&(c=`${a} - ${i} ${i>1?"Sesiones":"Sesi贸n"}`),{nombre:((n=e==null?void 0:e.paciente)==null?void 0:n.nombre)||"",horaInicio:((s=e==null?void 0:e.horario)==null?void 0:s.horaInicio.split("T")[0])||"",hora:(t||r)&&Y((d=e==null?void 0:e.horario)==null?void 0:d.horaInicio)||"",observaciones:(e==null?void 0:e.observaciones)||"",servicio:((m=e==null?void 0:e.servicio)==null?void 0:m.nombre)||"",tratamiento:c||"",estado:(e==null?void 0:e.estado)||""}},me=async(e,t)=>{const r=new Date(e).getDay(),i=X(e,M,q,k,B)[r];try{const c=`${y.reservas.reservasDia}${e}`,p={headers:{Authorization:`Bearer ${t||""}`}},u=await D(c,p),{datos:l,error:n}=u;return n?{error:n}:{horas:ue(i.horas,l),datos:l}}catch(c){console.log(c)}},ue=(e,t)=>e.map(r=>$(r,t)),pe=async(e,t)=>{const r=y.reservas.postReserva,a={method:"POST",body:JSON.stringify(t),headers:{Authorization:`Bearer ${e||""}`,"Content-Type":"application/json"}};return await D(r,a)},he=async(e,t,r)=>{const a=`${y.reservas.putReserva}${r}`,i={method:"PUT",headers:{"content-type":"application/json",authorization:`Bearer ${e}`},body:JSON.stringify(t)};return await D(a,i)},xe=e=>{const{accessToken:t}=oe(),{setMensaje:r}=I(),{setLoading:a}=O(),{dispatch:i}=H(),[c,p]=w.useState([]),[u,l]=w.useState([]);return w.useEffect(()=>{e&&(async()=>{a(!0);try{const m=await me(e,t),{datos:h,horas:b,error:x}=m;x?(r(x),p([])):(p(b),l(h))}catch{r("Error al obtener lar horas disponibles")}finally{a(!1)}})()},[t,r,e,a]),{horasDisponibles:c,reservasDelDia:u,agregarReserva:async d=>{try{a(!0);const m=await pe(t,d),{error:h,datos:b,mensaje:x,status:f}=m;return f===200?(r(x),i({type:R.SET_RESERVA_NUEVA,payload:b}),!0):h?(r(h),!1):(r("Ocurri贸 un error"),!1)}catch{r("Ocurri贸 un error")}finally{a(!1)}},editarReserva:async(d,m)=>{try{a(!0);const h=await he(t,d,m),{status:b,datos:x,error:f,mensaje:j}=h;return b===200?(r(j),i({type:R.SET_RESERVA_NUEVA,payload:x}),!0):f?(r(f),!1):(r("Error al actualizar la reserva"),!1)}catch{return r("Error al actualizar la reserva"),!1}finally{a(!1)}}}},_e=()=>{var A,T;const e=J(),t=G(),r=(A=e.state)==null?void 0:A.reserva,{setMensaje:a}=I(),{reserva:i,dispatch:c}=H(),{loading:p}=O(),u=e.pathname===F.admin.agregarReserva&&((T=e.state)==null?void 0:T.from)===F.admin.calendario,l=r.estado,{handleChange:n,values:s,errors:d,onSubmitForm:m,resetForm:h}=Z(de(i||r,l,u),le),{pacientesNombres:b}=ae();te();const{horasDisponibles:x,reservasDelDia:f,agregarReserva:j,editarReserva:V}=xe(s.horaInicio),L=g=>{n({target:{name:"hora",value:""}}),n(g)},z=async g=>{const N=ce(g);(l?await V(N,r._id):await j(N))?E():a("Ocurri贸 un guardar la reserva.")},E=()=>{h(),c({type:R.SET_RESERVA,payload:null}),t(-1)},U=g=>{const C={target:{name:"nombre",value:g.target.textContent}};n(C)},P=g=>g.map(N=>N.nombre);return o.jsxs("section",{className:"grid px-4 py-8",children:[o.jsxs("h1",{className:"font-betonga font-bold text-color-violeta text-2xl tracking-wider text-center mb-4",children:[l?"Editar":"Crear"," Reserva"]}),o.jsxs("form",{className:"animate-fadeIn rounded-lg p-4 max-w-xl m-auto w-full grid gap-4 bg-color-verde-blanco border border-gray-300 shadow-lg",onSubmit:g=>m(g,z),children:[o.jsx("p",{children:"Nombres de pacientes"}),o.jsx(ee,{name:"Pacientes existentes",onClickFunction:U,list:P(b)}),o.jsx(v,{placeholder:"Nombre",value:s.nombre,labelText:"Nombre",name:"nombre",type:"text",errors:d,onChange:n}),o.jsx(v,{className:"w-full",value:s.horaInicio.split("T")[0],labelText:"Fecha",name:"horaInicio",type:"date",errors:d,onChange:L}),x.length>0&&s.horaInicio&&o.jsx(o.Fragment,{children:o.jsx(ne,{horasDisponibles:x,values:s,setMensaje:a,handleChange:n,reservasDelDia:f,errors:d})}),o.jsx("label",{children:"Servicio y Tratamiento"}),o.jsx(Q,{values:s,handleChange:n,errors:d}),o.jsx(K,{value:s.observaciones,onChange:n,name:"observaciones",labelText:s.nombre==="admin"?"Compromisos separados por comas":"Observaciones"}),o.jsx(se,{values:s}),o.jsx(re,{errors:d}),o.jsxs("footer",{className:"grid grid-flow-col gap-4",children:[o.jsx(_,{bgColor:!0,className:"w-full",tipo:"submit",texto:"Guardar",disabled:p}),o.jsx(_,{className:"w-full",tipo:"button",onClickFunction:E,texto:"Cerrar"})]})]})]})};export{_e as default};
